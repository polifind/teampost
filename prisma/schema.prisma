generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // null for OAuth users
  name          String?
  image         String?
  emailVerified DateTime?

  // LinkedIn Integration (separate from OAuth sign-in)
  linkedinAccessToken  String?
  linkedinRefreshToken String?
  linkedinTokenExpiry  DateTime?
  linkedinUserId       String?

  // Onboarding status
  onboardingCompleted Boolean @default(false)

  // LinkedIn Profile Context (extracted from screenshots)
  linkedinProfileContext String? // AI-extracted summary of their professional background

  // Stripe subscription
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Relations
  accounts               Account[]
  sessions               Session[]
  voiceNotes             VoiceNote[]
  posts                  Post[]
  schedules              Schedule[]
  writingPreferences     WritingPreference[]
  linkedinScreenshots    LinkedInScreenshot[]
  conversations          Conversation[]
  photoLibrary           PhotoLibrary[]
  organizationMemberships OrganizationMember[]
  organizationNotes      OrganizationNote[]
  adminCreatedPosts      Post[]    @relation("AdminCreatedPosts")
  invitesSent            OrganizationMember[] @relation("InvitedMembers")
  ghostwriterGuidelines  GhostwriterGuideline[]
  lifeLibraryItems       LifeLibraryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model VoiceNote {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  questionIndex Int      // 0-9 for the 10 questions
  questionText  String   // The actual question text
  audioUrl      String?  // S3 URL (optional if using base64)
  audioData     String? // Base64 audio data (for demo/testing)
  transcription String?
  duration      Int?     // seconds

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, questionIndex])
}

model Post {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  content      String
  imageUrl     String?    // S3 URL for post image
  sourceNoteId String?    // which voice note inspired this
  weekNumber   Int        // 1-10 for scheduling

  status         PostStatus @default(DRAFT)
  linkedinPostId String?    // after posting to LinkedIn

  // Engagement metrics (updated after posting)
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)

  // Admin creation tracking (for org admin scheduled posts)
  createdByAdminId String?
  createdByAdmin   User?        @relation("AdminCreatedPosts", fields: [createdByAdminId], references: [id])
  organizationId   String?
  organization     Organization? @relation(fields: [organizationId], references: [id])

  // Bulk draft tracking (for bulk variations requiring approval)
  bulkDraftGroupId String?
  bulkDraftStatus  BulkDraftStatus?

  schedule Schedule?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdByAdminId])
  @@index([organizationId])
  @@index([bulkDraftGroupId])
}

model Schedule {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId       String         @unique
  post         Post           @relation(fields: [postId], references: [id], onDelete: Cascade)

  scheduledFor DateTime
  postedAt     DateTime?
  status       ScheduleStatus @default(PENDING)
  error        String? // Error message if posting failed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PostStatus {
  DRAFT
  SCHEDULED
  POSTED
  FAILED
}

enum ScheduleStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum BulkDraftStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

// Stores user's writing preferences learned from feedback
model WritingPreference {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // The preference/rule learned from feedback
  preference String // e.g., "Don't use emojis", "Keep posts under 200 words"
  category   String // e.g., "style", "tone", "length", "content", "avoid"

  // Context about when this was learned
  originalFeedback String? // The user's actual feedback that created this rule
  exampleBefore    String? // What the post said before
  exampleAfter     String? // What it was changed to

  isActive Boolean @default(true) // User can disable preferences

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Stores LinkedIn profile screenshots for AI context
model LinkedInScreenshot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Screenshot data (base64 encoded)
  imageData String // Base64 image data

  // What section of LinkedIn this covers
  sectionType String // "about", "experience", "education", "skills", "full_profile"

  // AI-extracted content from this screenshot
  extractedContent String? // Structured text extracted by AI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Stores in-progress conversations for post creation
model Conversation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Conversation title (auto-generated from first message)
  title    String

  // Messages stored as JSON array
  messages String // JSON: [{role, content, timestamp}]

  // Current draft if one was generated
  draftContent String?
  draftImageUrl String?

  // Status
  status ConversationStatus @default(IN_PROGRESS)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum ConversationStatus {
  IN_PROGRESS
  COMPLETED // Post was created from this conversation
  ABANDONED // User explicitly deleted/abandoned
}

// Photo library for storing user's photos
model PhotoLibrary {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  imageUrl  String  // Vercel Blob URL
  filename  String? // Original filename

  // Usage tracking
  usageCount Int @default(0) // How many times used in posts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Organization for company teams
model Organization {
  id          String @id @default(cuid())
  name        String
  slug        String @unique // URL-friendly identifier
  description String?
  logoUrl     String?

  // Domain for auto-join (e.g., "speechify.com")
  // Users with emails @domain will automatically join this org
  domain      String? @unique

  // Organization members
  members     OrganizationMember[]

  // Organization-wide notes for employees
  notes       OrganizationNote[]

  // Posts created by admins for org members
  posts       Post[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organization membership with roles
model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      // null if user hasn't signed up yet
  user           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email is stored separately for inviting users who haven't signed up
  email          String
  role           OrgMemberRole @default(MEMBER)

  // Invitation status
  invitedAt      DateTime @default(now())
  joinedAt       DateTime? // When they actually signed up/accepted

  // Invite token for link-based invites
  inviteToken       String?   @unique
  inviteTokenExpiry DateTime?
  inviteStatus      InviteStatus @default(PENDING)
  invitedById       String?   // Who sent the invite
  invitedBy         User?     @relation("InvitedMembers", fields: [invitedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email])
  @@index([userId])
  @@index([email])
  @@index([inviteToken])
}

enum InviteStatus {
  PENDING   // Invite sent, not yet accepted
  ACCEPTED  // User accepted the invite
  EXPIRED   // Invite token expired
}

enum OrgMemberRole {
  ADMIN  // Can manage members and create notes
  MEMBER // Regular employee
}

// Organization-wide notes/suggestions for employees
model OrganizationNote {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Note content
  title          String       // e.g., "Company-Wide Notes for Week of Jan 27"
  content        String       // The actual suggestions/guidance

  // Which week this is for (optional)
  weekStart      DateTime?    // Start of the week this applies to

  // Who created this
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id])

  // Pinned notes show at the top
  isPinned       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// Ghostwriter guidelines - persistent instructions for all posts
model GhostwriterGuideline {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  content   String   // The guideline text (e.g., "Always mention I'm a founder", "Avoid talking about competitors")
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Life Library - content repository for Magic Draft
model LifeLibraryItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content type
  type      LifeLibraryType

  // Source info
  sourceUrl     String?   // URL for links/youtube
  fileName      String?   // Original filename for uploads
  fileUrl       String?   // Vercel Blob URL for uploaded files

  // Extracted content
  title             String?   // Extracted or provided title
  extractedContent  String?   // AI-extracted text/summary (can be long)
  extractedSummary  String?   // Short summary for display

  // Processing status
  processingStatus  ProcessingStatus @default(PENDING)
  processingError   String?

  // Usage tracking
  usageCount    Int @default(0)
  lastUsedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
}

enum LifeLibraryType {
  LINK
  YOUTUBE
  PDF
  DOCX
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
